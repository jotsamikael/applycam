<div class="container-fluid">
    <app-page-title title="Applications Management" [breadcrumbItems]="breadCrumbItems"></app-page-title>

    <!-- Statistiques -->
    <div class="row mb-3">
        <div *ngFor="let stat of followUpStat" class="col-md-3 col-6 mb-2">
            <div class="card text-center border-0 shadow-sm bg-light">
                <div class="card-body p-2">
                    <i class="bx bx-{{stat.icon}} text-primary" style="font-size: 2rem;"></i>
                    <h5 class="mb-0 mt-1">{{ stat.value }}</h5>
                    <small class="text-muted">{{ stat.title }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Bouton Créer
    <div class="row justify-content-end mb-3">
        <div class="col-md-4 text-end">
            <button class="btn btn-soft-primary waves-effect waves-light mx-2" (click)="openCreateNewModal()">
                <i class="bx bx-plus me-1"></i> Create Application
            </button>
        </div>
    </div> -->

    <!-- Filtre -->
    <div class="row justify-content-end mt-3">
        <div class="col-md-3">
            <mat-form-field appearance="outline" class="w-100">
                <mat-label>Filter</mat-label>
                <input matInput (keyup)="applyFilter($event)" placeholder="Filter applications" #input>
                <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>
        </div>
    </div>

    <!-- Tableau des applications -->
    <div class="row">
        <div class="col-12">
            <div class="mat-elevation-z8">
                <table mat-table [dataSource]="dataSource" matSort class="w-100">

                    <!-- Candidate Name Column -->
                    <ng-container matColumnDef="candidateName">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Candidate </th>
                        <td mat-cell *matCellDef="let row"> {{row.candidateName}} </td>
                    </ng-container>

                    <!-- Email Column -->
                    <ng-container matColumnDef="email">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Email </th>
                        <td mat-cell *matCellDef="let row"> {{row.email}} </td>
                    </ng-container>

                    <!-- Exam Type Column -->
                    <ng-container matColumnDef="examType">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Exam Type </th>
                        <td mat-cell *matCellDef="let row"> {{row.examType}} </td>
                    </ng-container>

                    <!-- Speciality Column -->
                    <ng-container matColumnDef="speciality">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Speciality </th>
                        <td mat-cell *matCellDef="let row"> {{row.speciality}} </td>
                    </ng-container>

                    <!-- Status Column -->
                    <ng-container matColumnDef="status">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Status </th>
                        <td mat-cell *matCellDef="let row">
                            <span class="badge bg-info">{{row.status || 'DRAFT'}}</span>
                        </td>
                    </ng-container>

                    <!-- Actions Column -->
                    <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef class="text-end">Actions</th>
                        <td mat-cell *matCellDef="let row" class="text-end">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info btn-sm" (click)="showDetails(row)" title="Voir détails">
                                    <i class="bx bx-show"></i>
                                </button>
                                <button class="btn btn-outline-primary btn-sm" (click)="edit(row)" title="Edit">
                                    <i class="bx bx-edit"></i>
                                </button>
                                <button class="btn btn-outline-success btn-sm" (click)="validate(row)" title="Valider">
                                    <i class="bx bx-check"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" (click)="reject(row)" title="Rejeter">
                                    <i class="bx bx-block"></i>
                                </button>
                            </div>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

                    <!-- Row shown when there is no matching data. -->
                    <tr class="mat-row" *matNoDataRow>
                        <td class="mat-cell text-center py-4" colspan="7">
                            <div class="d-flex flex-column align-items-center">
                                <mat-icon class="mb-2" style="font-size: 48px;">search_off</mat-icon>
                                <h4 class="text-muted">No applications found</h4>
                            </div>
                        </td>
                    </tr>
                </table>

                <!-- Paginator -->
                <mat-paginator
                    [length]="totalElements"
                    [pageSize]="pageSize"
                    [pageIndex]="pageIndex"
                    [pageSizeOptions]="[5, 10, 25, 100]"
                    showFirstLastButtons
                    aria-label="Select page of applications"
                    (page)="onPageChange($event)">
                </mat-paginator>
            </div>
        </div>
    </div>
</div>

<!-- Create Application Modal -->
<ng-template #addNew>
    <div class="modal-header">
        <h5 class="modal-title">Create New Application</h5>
        <button type="button" class="btn-close" (click)="modalRef?.hide()" aria-label="Close"></button>
    </div>
    <form [formGroup]="CreateApplicationForm" (ngSubmit)="createNewApplication()">
        <div class="modal-body">
            <!-- Ajoute ici les champs du formulaire -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Candidate Name <span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="candidateName" type="text">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Email <span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="email" type="email">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Exam Type <span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="examType" type="text">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Speciality <span class="text-danger">*</span></label>
                    <select class="form-select" formControlName="speciality">
                        <option value="">Select Speciality</option>
                        <option *ngFor="let spec of specialities" [value]="spec.id">{{spec.name}}</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Application Region <span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="applicationRegion" type="text">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Nationality <span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="nationality" type="text">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Status <span class="text-danger">*</span></label>
                    <select class="form-select" formControlName="status">
                        <option value="DRAFT">Draft</option>
                        <option value="VALIDATED">Validated</option>
                        <option value="REJECTED">Rejected</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-light" (click)="modalRef?.hide()">Close</button>
            <button type="submit" class="btn btn-primary" [disabled]="CreateApplicationForm.invalid || processing">
                <span *ngIf="!processing">Create Application</span>
                <span *ngIf="processing" class="d-flex align-items-center">
                    <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                    Creating...
                </span>
            </button>
        </div>
    </form>
</ng-template>

<!-- Edit Application Modal -->
<ng-template #editTemplate>
    <div class="modal-header">
        <h5 class="modal-title">Edit Application</h5>
        <button type="button" class="btn-close" (click)="modalRef?.hide()" aria-label="Close"></button>
    </div>
    <form [formGroup]="CreateApplicationForm" (ngSubmit)="updateApplication()">
        <div class="modal-body">
            <!-- Même contenu que le modal de création -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Candidate Name <span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="candidateName" type="text">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Email <span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="email" type="email">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Exam Type <span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="examType" type="text">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Speciality <span class="text-danger">*</span></label>
                    <select class="form-select" formControlName="speciality">
                        <option value="">Select Speciality</option>
                        <option *ngFor="let spec of specialities" [value]="spec.id">{{spec.name}}</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Application Region <span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="applicationRegion" type="text">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Nationality <span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="nationality" type="text">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Status <span class="text-danger">*</span></label>
                    <select class="form-select" formControlName="status">
                        <option value="DRAFT">Draft</option>
                        <option value="VALIDATED">Validated</option>
                        <option value="REJECTED">Rejected</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-light" (click)="modalRef?.hide()">Cancel</button>
            <button type="submit" class="btn btn-primary" [disabled]="CreateApplicationForm.invalid || processing">
                <span *ngIf="!processing">Save Changes</span>
                <span *ngIf="processing" class="d-flex align-items-center">
                    <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                    Saving...
                </span>
            </button>
        </div>
    </form>
</ng-template>
