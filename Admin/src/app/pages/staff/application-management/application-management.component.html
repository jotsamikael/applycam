<div class="container-fluid">
    <app-page-title title="Applications Management" [breadcrumbItems]="breadCrumbItems"></app-page-title>

    <div class="row justify-content-end mb-3">
        <div class="col-md-4 text-end">
            <button class="btn btn-soft-primary waves-effect waves-light mx-2" (click)="openCreateNewModal()">
                <i class="bx bx-plus me-1"></i> Create Application
            </button>
        </div>
    </div>

    <div class="row">
        <div *ngFor="let stat of followUpStat" class="col-md-4">
            <app-stat [title]="stat.title" [value]="stat.value" [icon]="stat.icon"></app-stat>
        </div>
    </div>

    <div class="row justify-content-end mt-3">
        <div class="col-md-3">
            <mat-form-field appearance="outline" class="w-100">
                <mat-label>Filter</mat-label>
                <input matInput (keyup)="applyFilter($event)" placeholder="Filter applications" #input>
                <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="mat-elevation-z8">
                <table mat-table [dataSource]="dataSource" matSort class="w-100">

                    <!-- Last Name Column -->
                    <ng-container matColumnDef="lastName">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Last Name </th>
                        <td mat-cell *matCellDef="let row"> {{row.lastName}} </td>
                    </ng-container>

                    <!-- First Name Column -->
                    <ng-container matColumnDef="firstName">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> First Name </th>
                        <td mat-cell *matCellDef="let row"> {{row.firstName}} </td>
                    </ng-container>

                    <!-- Email Column -->
                    <ng-container matColumnDef="email">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Email </th>
                        <td mat-cell *matCellDef="let row"> {{row.email}} </td>
                    </ng-container>

                    <!-- Exam Type Column -->
                    <ng-container matColumnDef="examType">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Exam Type </th>
                        <td mat-cell *matCellDef="let row"> {{row.examType}} </td>
                    </ng-container>

                    <!-- Speciality Column -->
                    <ng-container matColumnDef="speciality">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Speciality </th>
                        <td mat-cell *matCellDef="let row"> {{row.speciality}} </td>
                    </ng-container>

                    <!-- Status Column -->
                    <ng-container matColumnDef="status">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Status </th>
                        <td mat-cell *matCellDef="let row"> {{row.status}} </td>
                    </ng-container>

                    <!-- Actions Column -->
                    <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef class="text-end">Actions</th>
                        <td mat-cell *matCellDef="let row" class="text-end">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary btn-sm" (click)="edit(row)" title="Edit">
                                    <i class="bx bx-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" (click)="delete(row)" title="Delete">
                                    <i class="bx bx-trash"></i>
                                </button>
                            </div>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

                    <!-- Row shown when there is no matching data. -->
                    <tr class="mat-row" *matNoDataRow>
                        <td class="mat-cell" colspan="7">No data matching the filter "{{input.value}}"</td>
                    </tr>
                </table>

                <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" showFirstLastButtons aria-label="Select page of applications"></mat-paginator>
            </div>
        </div>
    </div>
</div>

<!-- Create Application Modal -->
<ng-template #addNew>
    <div class="modal-header">
        <h5 class="modal-title">Create New Application</h5>
        <button type="button" class="btn-close" (click)="modalRef?.hide()" aria-label="Close"></button>
    </div>
    <form [formGroup]="CreateApplicationForm" (ngSubmit)="createNewApplication()">
        <div class="modal-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Last Name <span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="lastName" type="text">
                    <div *ngIf="f.lastName.touched && f.lastName.invalid" class="text-danger">
                        <small *ngIf="f.lastName.errors?.required">Last name is required</small>
                        <small *ngIf="f.lastName.errors?.maxlength">Max 64 characters</small>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">First Name <span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="firstName" type="text">
                    <div *ngIf="f.firstName.touched && f.firstName.invalid" class="text-danger">
                        <small *ngIf="f.firstName.errors?.required">First name is required</small>
                        <small *ngIf="f.firstName.errors?.maxlength">Max 64 characters</small>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Email <span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="email" type="email">
                    <div *ngIf="f.email.touched && f.email.invalid" class="text-danger">
                        <small *ngIf="f.email.errors?.required">Email is required</small>
                        <small *ngIf="f.email.errors?.email">Invalid email</small>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Phone Number <span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="phoneNumber" type="text">
                    <div *ngIf="f.phoneNumber.touched && f.phoneNumber.invalid" class="text-danger">
                        <small *ngIf="f.phoneNumber.errors?.required">Phone number is required</small>
                        <small *ngIf="f.phoneNumber.errors?.pattern">Invalid phone number</small>
                    </div>
                </div>
            </div>
            <!-- Ajoute ici les autres champs du formulaire selon ApplicationRequest -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Exam Type <span class="text-danger">*</span></label>
                    <input class="form-control" formControlName="examType" type="text">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Speciality <span class="text-danger">*</span></label>
                    <select class="form-select" formControlName="speciality">
                        <option value="">Select Speciality</option>
                        <option *ngFor="let spec of specialities" [value]="spec.id">{{spec.name}}</option>
                    </select>
                </div>
            </div>
            <!-- Ajoute d'autres champs selon besoin -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-light" (click)="modalRef?.hide()">Close</button>
            <button type="submit" class="btn btn-primary" [disabled]="CreateApplicationForm.invalid || processing">
                <span *ngIf="!processing">Create Application</span>
                <span *ngIf="processing" class="d-flex align-items-center">
                    <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                    Creating...
                </span>
            </button>
        </div>
    </form>
</ng-template>

<!-- Edit Application Modal -->
<ng-template #editTemplate>
    <div class="modal-header">
        <h5 class="modal-title">Edit Application</h5>
        <button type="button" class="btn-close" (click)="modalRef?.hide()" aria-label="Close"></button>
    </div>
    <form [formGroup]="CreateApplicationForm" (ngSubmit)="updateApplication()">
        <div class="modal-body">
            <!-- Même contenu que le modal de création -->
            <!-- ...copie le contenu du formulaire ci-dessus... -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-light" (click)="modalRef?.hide()">Cancel</button>
            <button type="submit" class="btn btn-primary" [disabled]="CreateApplicationForm.invalid || processing">
                <span *ngIf="!processing">Save Changes</span>
                <span *ngIf="processing" class="d-flex align-items-center">
                    <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                    Saving...
                </span>
            </button>
        </div>
    </form>
</ng-template>
