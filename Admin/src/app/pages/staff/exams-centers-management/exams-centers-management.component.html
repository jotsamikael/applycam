<div class="container-fluid">
    <h2>Gestion des Centres d'Examen</h2>
    
    <!-- Barre d'outils -->
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" (click)="refreshExamCenters()" [disabled]="refreshing">
                    <i class="bx bx-refresh" [class.bx-spin]="refreshing"></i>
                    {{ refreshing ? 'Actualisation...' : 'Actualiser' }}
                </button>
                <button class="btn btn-outline-info" (click)="exportExamCentersToExcel()">
                    <i class="bx bx-export"></i>
                    Exporter
                </button>
            </div>
        </div>
        <div class="col-md-6 text-end">
            <div class="d-flex gap-2 justify-content-end">
                <button class="btn btn-outline-secondary" (click)="toggleAdvancedFilters()">
                    <i class="bx bx-filter-alt"></i>
                    {{ showAdvancedFilters ? 'Masquer' : 'Afficher' }} les filtres
                </button>
                <button class="btn btn-soft-primary waves-effect waves-light" 
                        (click)="openCreateExamCenterModal()">
                    <i class="bx bx-plus"></i> Créer un Centre d'Examen
                </button>
            </div>
        </div>
    </div>

    <!-- Filtres avancés -->
    <div class="row mb-3" *ngIf="showAdvancedFilters">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="bx bx-filter-alt me-2"></i>
                        Filtres avancés - Centres d'Examen
                    </h6>
                </div>
                <div class="card-body">
                    <form [formGroup]="filterForm" class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Région</label>
                            <select class="form-select" formControlName="region">
                                <option value="">Toutes</option>
                                <option *ngFor="let region of regionOptions" [value]="region">
                                    {{ region }}
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Division</label>
                            <select class="form-select" formControlName="division">
                                <option value="">Toutes</option>
                                <option *ngFor="let division of divisionOptions" [value]="division">
                                    {{ division }}
                                </option>
                            </select>
                        </div>
                        <div class="col-12">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-primary" (click)="applyAdvancedFilters()">
                                    <i class="bx bx-search"></i>
                                    Appliquer les filtres
                                </button>
                                <button type="button" class="btn btn-outline-secondary" (click)="clearFilters()">
                                    <i class="bx bx-x"></i>
                                    Effacer
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Statistiques des centres d'examen -->
    <div class="row">
        <div *ngFor="let stat of examCenterStats" class="col-md-3">
            <app-stat [title]="stat.title" [value]="stat.value" [icon]="stat.icon"></app-stat>
        </div>
    </div>
    
    <!-- Table des centres d'examen -->
    <div class="row mt-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="row justify-content-between mb-3">
                        <div class="col-md-4">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>Filtrer les centres d'examen</mat-label>
                                <input matInput (keyup)="applyFilter($event)" #inputExamCenters placeholder="Rechercher par nom ou région">
                                <mat-icon matSuffix>search</mat-icon>
                            </mat-form-field>
                        </div>
                        <div class="col-md-2 text-end">
                            <button mat-icon-button matTooltip="Refresh list" (click)="loadExamCenters()">
                                <mat-icon>refresh</mat-icon>
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table mat-table [dataSource]="dataSource" matSort class="w-100">
                            <!-- Name Column -->
                            <ng-container matColumnDef="name">
                                <th mat-header-cell *matHeaderCellDef mat-sort-header> 
                                    <i class="bx bx-building me-1"></i>Nom du Centre 
                                </th>
                                <td mat-cell *matCellDef="let examCenter"> 
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm me-2">
                                            <div class="avatar-title bg-light rounded-circle">
                                                <i class="bx bx-building"></i>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="fw-semibold">{{examCenter.name || 'N/A'}}</div>
                                            <small class="text-muted">ID: {{examCenter.id}}</small>
                                        </div>
                                    </div>
                                </td>
                            </ng-container>

                            <!-- Region Column -->
                            <ng-container matColumnDef="region">
                                <th mat-header-cell *matHeaderCellDef mat-sort-header> 
                                    <i class="bx bx-map me-1"></i>Région 
                                </th>
                                <td mat-cell *matCellDef="let examCenter"> 
                                    <span class="badge bg-primary">{{examCenter.region || 'N/A'}}</span>
                                </td>
                            </ng-container>

                            <!-- Division Column -->
                            <ng-container matColumnDef="division">
                                <th mat-header-cell *matHeaderCellDef mat-sort-header> 
                                    <i class="bx bx-map-pin me-1"></i>Division 
                                </th>
                                <td mat-cell *matCellDef="let examCenter"> 
                                    <span class="badge bg-info">{{examCenter.division || 'N/A'}}</span>
                                </td>
                            </ng-container>

                            <!-- Capacity Column -->
                            <ng-container matColumnDef="capacity">
                                <th mat-header-cell *matHeaderCellDef mat-sort-header> 
                                    <i class="bx bx-users me-1"></i>Capacité 
                                </th>
                                <td mat-cell *matCellDef="let examCenter"> 
                                    <span class="fw-semibold text-success">
                                        {{examCenter.capacity || 0}} candidats
                                    </span>
                                </td>
                            </ng-container>

                            <!-- Actions Column -->
                            <ng-container matColumnDef="actions">
                                <th mat-header-cell *matHeaderCellDef class="text-end">
                                    <i class="bx bx-cog me-1"></i>Actions
                                </th>
                                <td mat-cell *matCellDef="let examCenter" class="text-end">
                                    <div class="d-flex justify-content-end gap-1">
                                        <button mat-icon-button color="primary" matTooltip="Voir les détails" (click)="openDetailExamCenterPopup(examCenter)">
                                            <mat-icon>visibility</mat-icon>
                                        </button>
                                        <button mat-icon-button color="accent" matTooltip="Modifier" (click)="editExamCenter(examCenter)">
                                            <mat-icon>edit</mat-icon>
                                        </button>
                                        <button mat-icon-button color="success" matTooltip="Assigner" (click)="assignExamCenter(examCenter)">
                                            <mat-icon>assignment</mat-icon>
                                        </button>
                                        <button mat-icon-button color="warn" matTooltip="Supprimer" (click)="deleteExamCenter(examCenter)" 
                                                [disabled]="processing">
                                            <mat-icon>delete</mat-icon>
                                        </button>
                                    </div>
                                </td>
                            </ng-container>

                            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                            <tr class="mat-row" *matNoDataRow>
                                <td class="mat-cell text-center py-4" [attr.colspan]="displayedColumns.length">
                                    <div class="d-flex flex-column align-items-center">
                                        <mat-icon class="mb-2" style="font-size: 48px; height: 48px; width: 48px;">search_off</mat-icon>
                                        <h4 class="text-muted">Aucun centre d'examen trouvé</h4>
                                        <p *ngIf="inputExamCenters.value" class="text-muted">
                                            Aucun résultat pour "{{inputExamCenters.value}}"
                                        </p>
                                        <button mat-raised-button color="primary" class="mt-2" (click)="openCreateExamCenterModal()" *ngIf="!inputExamCenters.value">
                                            Créer votre premier centre d'examen
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" showFirstLastButtons aria-label="Select page of exam centers" class="mt-3"></mat-paginator>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour les centres d'examen -->
    <div class="modal fade show" [ngClass]="{'d-block': showModal}" tabindex="-1" role="dialog" *ngIf="showModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{isEditMode ? 'Modifier' : 'Créer'}} un Centre d'Examen</h5>
                    <button type="button" class="btn-close" (click)="closeModal()" aria-label="Close"></button>
                </div>
                <form [formGroup]="examCenterForm" (ngSubmit)="onSubmit()">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nom du Centre *</label>
                                    <input type="text" class="form-control" formControlName="name" placeholder="Nom du centre d'examen">
                                    <div *ngIf="f['name'].touched && f['name'].invalid" class="text-danger">
                                        <small *ngIf="f['name'].errors?.['required']">Le nom est requis</small>
                                        <small *ngIf="f['name'].errors?.['minlength']">Le nom doit contenir au moins 2 caractères</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Capacité *</label>
                                    <input type="number" class="form-control" formControlName="capacity" placeholder="Nombre de candidats" min="1">
                                    <div *ngIf="f['capacity'].touched && f['capacity'].invalid" class="text-danger">
                                        <small *ngIf="f['capacity'].errors?.['required']">La capacité est requise</small>
                                        <small *ngIf="f['capacity'].errors?.['min']">La capacité doit être supérieure à 0</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Région *</label>
                                    <select class="form-select" formControlName="region">
                                        <option value="">Sélectionner une région</option>
                                        <option *ngFor="let region of regionOptions" [value]="region">
                                            {{ region }}
                                        </option>
                                    </select>
                                    <div *ngIf="f['region'].touched && f['region'].invalid" class="text-danger">
                                        <small *ngIf="f['region'].errors?.['required']">La région est requise</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Division *</label>
                                    <select class="form-select" formControlName="division">
                                        <option value="">Sélectionner une division</option>
                                        <option *ngFor="let division of divisionOptions" [value]="division">
                                            {{ division }}
                                        </option>
                                    </select>
                                    <div *ngIf="f['division'].touched && f['division'].invalid" class="text-danger">
                                        <small *ngIf="f['division'].errors?.['required']">La division est requise</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" (click)="closeModal()">Annuler</button>
                        <button type="submit" class="btn btn-primary" [disabled]="processing || examCenterForm.invalid">
                            <span *ngIf="!processing">
                                {{isEditMode ? 'Mettre à jour' : 'Créer'}}
                            </span>
                            <span *ngIf="processing" class="d-flex align-items-center">
                                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                                {{isEditMode ? 'Mise à jour...' : 'Création...'}}
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
