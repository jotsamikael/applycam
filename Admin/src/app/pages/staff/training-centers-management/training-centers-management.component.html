<div class="container-fluid">
   
    <div class="row mt-3">
      <div class="col-md-12">
        <div class="card">
          <div class="card-body">
            <div class="container-fluid">
                <app-page-title title="Training Centers Management"></app-page-title>
              
                <!-- Bouton Créer -->
                <div class="row justify-content-end mb-3">
                  <div class="col-md-4 text-end">
                    <button class="btn btn-soft-primary waves-effect waves-light mx-2" (click)="openCreateModal()">
                      <i class="bx bx-plus me-1"></i> Créer un centre
                    </button>
                  </div>
                </div>
              
                <!-- Cartes statistiques -->
                <div class="row">
                  <div *ngFor="let stat of followUpStat" class="col-md-4">
                    <app-stat [title]="stat.title" [value]="stat.value" [icon]="stat.icon"></app-stat>
                  </div>
                </div>
              
                <!-- Filtre -->
                <div class="row justify-content-end mt-3">
                  <div class="col-md-3">
                    <mat-form-field appearance="outline" class="w-100">
                      <mat-label>Filter</mat-label>
                      <input matInput (keyup)="applyFilter($event)" placeholder="Filter centers" #input>
                      <mat-icon matSuffix>search</mat-icon>
                    </mat-form-field>
                  </div>
                </div>
              
            <!-- Filtre + Refresh + Créer -->
           
            <!-- Table des centres de formation -->
            <div class="table-responsive">
              <table mat-table [dataSource]="dataSource" matSort class="w-100">
                <ng-container matColumnDef="fullName">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Nom</th>
                  <td mat-cell *matCellDef="let c"> <strong>{{ c.fullName || 'N/A' }}</strong> </td>
                </ng-container>
                <ng-container matColumnDef="acronym">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Acronyme</th>
                  <td mat-cell *matCellDef="let c"> {{ c.acronym || 'N/A' }} </td>
                </ng-container>
                <ng-container matColumnDef="agreementNumber">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Numéro d'agrément</th>
                  <td mat-cell *matCellDef="let c"> {{ c.agreementNumber || 'N/A' }} </td>
                </ng-container>
                <ng-container matColumnDef="division">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Division</th>
                  <td mat-cell *matCellDef="let c"> {{ c.division || 'N/A' }} </td>
                </ng-container>
                <ng-container matColumnDef="promoter">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Promoteur</th>
                  <td mat-cell *matCellDef="let c"> {{ c.promoter || 'N/A' }} </td>
                </ng-container>
                <ng-container matColumnDef="startDateOfAgreement">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Date début agrément</th>
                  <td mat-cell *matCellDef="let c"> {{ c.startDateOfAgreement ? (c.startDateOfAgreement | date:'dd/MM/yyyy') : 'N/A' }} </td>
                </ng-container>
                <ng-container matColumnDef="endDateOfAgreement">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Date fin agrément</th>
                  <td mat-cell *matCellDef="let c"> {{ c.endDateOfAgreement ? (c.endDateOfAgreement | date:'dd/MM/yyyy') : 'N/A' }} </td>
                </ng-container>
                <ng-container matColumnDef="centerPresentCandidateForCqp">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>CQP</th>
                  <td mat-cell *matCellDef="let c"> {{ c.centerPresentCandidateForCqp ? 'Oui' : 'Non' }} </td>
                </ng-container>
                <ng-container matColumnDef="centerPresentCandidateForDqp">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>DQP</th>
                  <td mat-cell *matCellDef="let c"> {{ c.centerPresentCandidateForDqp ? 'Oui' : 'Non' }} </td>
                </ng-container>
                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>Statut</th>
                  <td mat-cell *matCellDef="let c">
                    <span [ngClass]="{
                      'badge bg-success': (c.trainingCenterStatusHistory?.status || c.status) === 'VALIDATED',
                      'badge bg-warning': (c.trainingCenterStatusHistory?.status || c.status) === 'PENDING' || (c.trainingCenterStatusHistory?.status || c.status) === 'DRAFT',
                      'badge bg-danger': (c.trainingCenterStatusHistory?.status || c.status) === 'REJECTED',
                      'badge bg-info': (c.trainingCenterStatusHistory?.status || c.status) === 'INCOMPLETED',
                      'badge bg-primary': (c.trainingCenterStatusHistory?.status || c.status) === 'READYTOPAY',
                      'badge bg-secondary': (c.trainingCenterStatusHistory?.status || c.status) === 'PAID'
                    }">
                      {{ c.trainingCenterStatusHistory?.status || c.status || 'N/A' }}
                    </span>
                  </td>
                </ng-container>
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef class="text-end">Actions</th>
                  <td mat-cell *matCellDef="let c" class="text-end">
                    <div class="d-flex justify-content-end gap-1">
                      <button mat-icon-button color="accent" matTooltip="Edit" (click)="edit(c)">
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button mat-icon-button color="warn" matTooltip="Delete" (click)="delete(c)" [disabled]="processing">
                        <mat-icon>delete</mat-icon>
                      </button>
                      <button mat-icon-button color="primary" matTooltip="Details" (click)="openDetailModal(c)">
                        <mat-icon>visibility</mat-icon>
                      </button>
                      <button mat-icon-button color="warning" matTooltip="Changer le statut" (click)="onChangeStatus(c)">
                        <mat-icon>autorenew</mat-icon>
                      </button>
                    </div>
                  </td>
                </ng-container>
                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                <tr class="mat-row" *matNoDataRow>
                  <td class="mat-cell text-center py-4" colspan="10">
                    <div class="d-flex flex-column align-items-center">
                      <mat-icon class="mb-2" style="font-size: 48px;">search_off</mat-icon>
                      <h4 class="text-muted">No training centers found</h4>
                    </div>
                  </td>
                </tr>
              </table>
            </div>

            <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]"
                           showFirstLastButtons
                           aria-label="Select page of training centers"
                           class="mt-3">
            </mat-paginator>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-backdrop fade show" *ngIf="showModal">
      <div class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Détails du centre de formation</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <p><strong>Nom :</strong> {{ selectedTrainingCenter?.fullName || '-' }}</p>
              <p><strong>Acronyme :</strong> {{ selectedTrainingCenter?.acronym || '-' }}</p>
              <p><strong>Numéro d'agrément :</strong> {{ selectedTrainingCenter?.agreementNumber || '-' }}</p>
              <p><strong>Division :</strong> {{ selectedTrainingCenter?.division || '-' }}</p>
              <p><strong>Promoteur :</strong> {{ selectedTrainingCenter?.promoter || '-' }}</p>
              <p><strong>Date début agrément :</strong> {{ selectedTrainingCenter?.startDateOfAgreement || '-' }}</p>
              <p><strong>Date fin agrément :</strong> {{ selectedTrainingCenter?.endDateOfAgreement || '-' }}</p>
              <p><strong>CQP :</strong> {{ selectedTrainingCenter?.centerPresentCandidateForCqp ? 'Oui' : 'Non' }}</p>
              <p><strong>DQP :</strong> {{ selectedTrainingCenter?.centerPresentCandidateForDqp ? 'Oui' : 'Non' }}</p>
              <p><strong>Statut :</strong> {{ selectedTrainingCenter?.status || 'N/A' }}</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary">Save changes</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>