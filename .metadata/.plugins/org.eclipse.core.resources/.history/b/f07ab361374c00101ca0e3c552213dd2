package com.jotsamikael.applycam.payment;

import java.time.LocalDateTime;
import java.util.List;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Sort;
import org.springframework.security.core.Authentication;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import com.jotsamikael.applycam.candidate.CandidateRepository;
import com.jotsamikael.applycam.common.FileStorageService;
import com.jotsamikael.applycam.common.PageResponse;
import com.jotsamikael.applycam.email.EmailService;
import com.jotsamikael.applycam.promoter.PromoterMapper;
import com.jotsamikael.applycam.promoter.PromoterRepository;
import com.jotsamikael.applycam.role.RoleRepository;
import com.jotsamikael.applycam.trainingCenter.TrainingCenterRepository;
import com.jotsamikael.applycam.user.TokenRepository;
import com.jotsamikael.applycam.user.User;
import com.jotsamikael.applycam.user.UserRepository;

import jakarta.persistence.EntityNotFoundException;
import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class PaymentService {
	
	private final CandidateRepository candidateRepository;
	private final PaymentRepository paymentRepository;
	
	public String toPay(Authentication connectedUser,
			CreatePaymenRequest request) {
		
		User user = ((User) connectedUser.getPrincipal());
		
		candidateRepository.findByEmail(user.getEmail())
		.orElseThrow(()-> new EntityNotFoundException("You are not a candidate"));
		
		var payment=Payment.builder()
				.amount(request.getAmount())
				.paymentMethod(request.getPaymentMethod())
				.secretCode(request.getSecretCode())
				.createdBy(user.getIdUser())
				.createdDate(LocalDateTime.now())
				.isActived(true)
				.build();
		
	
		
		paymentRepository.save(payment);
		
		return "Succes";
	}
	
	public String updatePayment(Long id, CreatePaymenRequest request,Authentication connectedUser) {
		
		 User user = ((User) connectedUser.getPrincipal());
		 
		
		Payment payment= paymentRepository.findById(id)
				.orElseThrow(()-> new EntityNotFoundException("Payment not found"));
		
		payment.setAmount(request.getAmount());
		payment.setPaymentMethod(request.getPaymentMethod());
		payment.setSecretCode(request.getSecretCode());
		payment.setLastModifiedBy(user.getIdUser());
		payment.setLastModifiedDate(LocalDateTime.now());
		
		paymentRepository.save(payment);
		
		return "Update Success";
		
	}
	
	public void deletePayment(Long id) {
		
		Payment payment= paymentRepository.findById(id)
				.orElseThrow(()-> new EntityNotFoundException("Payment not found"));
		
		paymentRepository.delete(payment);
	}
	
	public PageResponse<PaymentResponse> getAllPyment(int offset, int pageSize, 
			String field, boolean order){
		
		Sort sort = order ? Sort.by(field).ascending() : Sort.by(field).descending();
		
		Page<Payment> list=paymentRepository.getAllPayments(PageRequest.of(offset, pageSize, sort));
		
		List<PaymentResponse> paymentResponses= list.getContent().stream().map(payment->PaymentResponse.builder()
				.id(payment.getId())
				.amount(payment.getAmount())
				.paymentMethod(payment.getPaymentMethod())
				.build()).toList();
		
		return new PageResponse<>(
				paymentResponses,
				list.getNumber(),
	            list.getSize(),
	            list.getTotalElements(),
	            list.getTotalPages(),
	            list.isFirst(),
	            list.isLast()
	    );
	}

}
