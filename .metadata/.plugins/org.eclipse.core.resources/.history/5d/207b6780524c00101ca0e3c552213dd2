package com.jotsamikael.applycam.common;

import com.jotsamikael.applycam.trainingCenter.TrainingCenter;
import lombok.NonNull;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.Set;

import static java.lang.System.currentTimeMillis;

@Service
@RequiredArgsConstructor
@Slf4j
public class FileStorageService {

    @Value("${application.file.upload.files-output-path}")
    private String fileUploadPath;
    
    private static final Set<String> ALLOWED_EXTENSIONS = Set.of("jpg", "jpeg", "png", "pdf", "docx");

public String saveFile(@NonNull MultipartFile sourceFile, @NonNull Long idUser, @NonNull String fileType){
	
	 String originalFilename = sourceFile.getOriginalFilename();
	    
	    if (!isAllowedExtension(originalFilename)) {
	        throw new IllegalArgumentException("Extension non autoris√©e pour le fichier : " + originalFilename);
	    }
	    
   final String fileUploadSubPath = "users"+ File.separator+ idUser+ File.separator + fileType.toLowerCase();

    return uploadFile(sourceFile, fileUploadSubPath,fileType);
}

    private String uploadFile(@NonNull MultipartFile sourceFile,
                              @NonNull String fileUploadSubPath,
                              @NonNull String fileType) {
    final String finalUploadPath = fileUploadPath+File.separator+ fileUploadSubPath;

    File targetFolder = new File(finalUploadPath);
    if(!targetFolder.exists()){
        boolean folderCreated = targetFolder.mkdirs();
        if(!folderCreated){
            log.warn("Failed to create the target folder");
            return null;

        }
    }

    final String fileExtension = getFileExtension(sourceFile.getOriginalFilename());

    //rename the file to something like ./uploads/users/120/232347851452.pdf
    String targetFilePath = finalUploadPath+File.separator+ fileType.toUpperCase() + "_"+ currentTimeMillis()+"."+fileExtension;
    Path targetPath = Path.of(targetFilePath);
    try{
        Files.write(targetPath, sourceFile.getBytes());
        log.info("File saved to",targetFilePath);
        return targetFilePath;

    }catch (IOException exception){
        log.error("File not saved",exception);
    }
    return targetFilePath;
    }

    private String getFileExtension(String originalFilename) {
    if(originalFilename == null || originalFilename.isEmpty()){
       return "";
    }

    int lastDotIndex = originalFilename.lastIndexOf(".");
    if(lastDotIndex == -1){
        return "";
    }
        return originalFilename.substring(lastDotIndex+1).toLowerCase();
    }
    
    private boolean isAllowedExtension(String filename) {
        String extension = getFileExtension(filename);
        return ALLOWED_EXTENSIONS.contains(extension.toLowerCase());
    }

}

