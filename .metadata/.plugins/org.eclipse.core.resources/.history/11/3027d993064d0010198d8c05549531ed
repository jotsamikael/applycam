package com.jotsamikael.applycam.application;

import java.time.LocalDate;
import java.time.LocalDateTime;

import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import com.jotsamikael.applycam.candidate.Candidate;
import com.jotsamikael.applycam.candidate.CandidateRepository;
import com.jotsamikael.applycam.common.ContentStatus;
import com.jotsamikael.applycam.common.FileStorageService;
import com.jotsamikael.applycam.email.EmailService;
import com.jotsamikael.applycam.email.EmailTemplateName;
import com.jotsamikael.applycam.examCenter.ExamCenter;
import com.jotsamikael.applycam.examCenter.ExamService;
import com.jotsamikael.applycam.payment.Payment;
import com.jotsamikael.applycam.payment.PaymentRepository;
import com.jotsamikael.applycam.session.Session;
import com.jotsamikael.applycam.session.SessionRepository;
import com.jotsamikael.applycam.speciality.Speciality;
import com.jotsamikael.applycam.speciality.SpecialityRepository;
import com.jotsamikael.applycam.staff.Staff;
import com.jotsamikael.applycam.staff.StaffRepository;
import com.jotsamikael.applycam.trainingCenter.TrainingCenter;
import com.jotsamikael.applycam.trainingCenter.TrainingCenterRepository;
import com.jotsamikael.applycam.user.User;
import com.jotsamikael.applycam.user.UserRepository;

import jakarta.mail.MessagingException;
import jakarta.persistence.EntityNotFoundException;
import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class ApplicationService {

    private final CandidateRepository candidateRepository;
    private final UserRepository userRepository;
    private final SpecialityRepository specialityRepository;
    private final ApplicationRepository applicationRepository;
    private final SessionRepository sessionRepository;
    private final TrainingCenterRepository trainingCenterRepository;
    private final PaymentRepository paymentRepository;
    private final FileStorageService fileStorageService;
    private final StaffRepository staffRepository;
    private final EmailService emailService;
    private final ExamService examService;

    public void applyPersonalInfo(ApplicationRequest request, Authentication connectedUser) {
        User user = ((User) connectedUser.getPrincipal());

        Candidate candidate = candidateRepository.findByEmail(user.getEmail())
        .orElseThrow(() -> new EntityNotFoundException(" Not a Candidate "));

        if (candidate == null) {
            throw new RuntimeException("Candidate not found");
        }
        
        if (!candidate.getFirstname().equalsIgnoreCase(request.getFirstName()) ||
                !candidate.getLastname().equalsIgnoreCase(request.getLastName())||
                !candidate.getPhoneNumber().equalsIgnoreCase(request.getPhoneNumber()) ||
                !candidate.getEmail().equalsIgnoreCase(request.getEmail()) 
                ) {
                
                throw new IllegalArgumentException("Les informations fournies ne correspondent pas à celles de votre enregistrement.");
            }
        
        		candidate.setSex(request.getSex());
        		candidate.setDateOfBirth(LocalDate.parse(request.getDateOfBirth()));
        		candidate.setPlaceOfBirth(request.getPlaceOfBirth());
        		candidate.setNationality(request.getNationality());
        		candidate.setRegionOrigins(request.getRegionOrigins());
        		candidate.setDepartmentOfOrigin(request.getDepartmentOfOrigin());
        		candidate.setMatrimonialSituation(request.getMatrimonialSituation());
        		candidate.setNumberOfKid(request.getNumberOfKid());
        		candidate.setLearningLanguage(request.getLearningLanguage());
        		candidate.setFreeCandidate(request.getFreeCandidate());
        		candidate.setRepeatCandidate(request.getRepeatCandidate());
        		candidate.setFormationMode(request.getFormationMode()); 
        		candidate.setFormationMode(request.getFormationMode());
        		candidate.setFinancialRessource(request.getFinancialRessource());
        		candidate.setHighestSchoolLevel(request.getAcademicLevel());
        		
        candidateRepository.save(candidate);
        Session session= sessionRepository.findBySessionYearAndExamType(request.getSessionYear(),request.getExamType())
        		.orElseThrow(() -> new EntityNotFoundException(" Not Session Found for this Year "));
        

        TrainingCenter trainingCenter = trainingCenterRepository.findByAcronym(request.getTrainingCenterAcronym())
        		.orElseThrow(() -> new EntityNotFoundException(" Not a training Center "));
        
        TrainingCenter trainingCenterIf= trainingCenterRepository.findByCandidateId(candidate.getIdUser())
        		.orElseThrow(() -> new EntityNotFoundException(" you are Not a candidate of this training Center "));
        
        if (!trainingCenter.getFullName().equals(trainingCenterIf.getFullName())) {
            throw new RuntimeException("You are note candidate ok this center");
        }

        //get exam information from the request
        Speciality speciality = specialityRepository.findByName(request.getSpeciality())
            .orElseThrow(() -> new EntityNotFoundException("Speciality not found"));

        var payment=Payment.builder()
				.amount(request.getAmount())
				.paymentMethod(request.getPaymentMethod())
				.secretCode(request.getSecretCode())
				.createdBy(user.getIdUser())
				.createdDate(LocalDateTime.now())
				.isActived(true)
				.build();
        
        paymentRepository.save(payment);
        
        var application = Application.builder()
        		.speciality(speciality)
        		.candidate(candidate)
        		.session(session)
        		.applicationRegion(request.getApplicationRegion())
        		.applicationYear(session.getSessionYear())
        		.payment(payment)
        		//.status(ContentStatus.PAID)
        		.build();
        
        
        applicationRepository.save(application);

    }
    
    public void uploadCandidateFile(MultipartFile cniFile,Authentication connectedUser,MultipartFile birthCertificate,
    		MultipartFile diplomFile,MultipartFile photo,MultipartFile oldApplyanceFile,MultipartFile stageCertificate,
    		MultipartFile cv,MultipartFile financialJustification,MultipartFile letter) {
    	
    	User user = ((User) connectedUser.getPrincipal());
    	
    	Candidate candidate= candidateRepository.findByEmail(user.getEmail())
    			.orElseThrow(() -> new EntityNotFoundException(" Not a Candidate "));
    	
    	handleFileUploads(candidate, cniFile,"CNI");
    	handleFileUploads(candidate, birthCertificate,"BIRTHCERTIFICATE");
    	handleFileUploads(candidate, diplomFile,"DIPLOM");
    	handleFileUploads(candidate, photo,"PHOTO");
    	handleFileUploads(candidate, oldApplyanceFile,"OLD");
    	handleFileUploads(candidate, stageCertificate,"CERTIFICATE");
    	handleFileUploads(candidate, cv,"CV");
    	handleFileUploads(candidate, financialJustification,"FINANCIAL");
    	handleFileUploads(candidate, letter,"LETTER");
    	
    	candidateRepository.save(candidate);
    	
    }
    
    
    
    
    
    private void handleFileUploads(Candidate candidate, MultipartFile file,String fileType) {
        if (file != null && !file.isEmpty()) {
            String url = fileStorageService.saveFile(file, candidate.getIdUser(),fileType);
            switch (fileType) {
            case "CNI" ->candidate.setNationalIdCardUrl(url);
            case "PHOTO" -> candidate.setProfilePictureUrl(url);
            case "BIRTHCERTIFICATE" -> candidate.setBirthCertificateUrl(url);
            case "DIPLOM" -> candidate.setHighestDiplomatUrl(url);
            case "LETTER" -> candidate.setLetterUrl(url);
            case "FINANCIAL" -> candidate.setFinancialJustificationUrl(url);
            case "CERTIFICATE" -> candidate.setStageCertificateUrl(url);
            case "OLD" -> candidate.setOldApplyanceUrl(url);
            case "CV" -> candidate.setCvUrl(url);
            
            default -> throw new IllegalArgumentException("we do not handel this folder.");
        }
            candidateRepository.save(candidate);
          
        } else {
            return;
        }
    }
    
    private String validateApplication(Authentication connectedUser,Long id) {
    	
    	User user = ((User) connectedUser.getPrincipal());
    	
    	Staff staff= staffRepository.findByEmail(user.getEmail())
    			.orElseThrow(()-> new EntityNotFoundException("No staff with found email"+ user.getEmail()));
    	
    	Application application= applicationRepository.findById(id)
    			.orElseThrow(()-> new EntityNotFoundException("No Application with found "));
    	
    	Candidate candidate=application.getCandidate();
    	
    	examService.assignRandomExamCenterToCandidate(candidate.getIdUser());
    	
    	Session session= application.getSession();
    	application.setActived(true);
    	
    	sendValidationEmail(candidate,);
    	
    }
    
    private void sendValidationEmail(Candidate candidate, ExamCenter examCenter,Session session) throws MessagingException {
        
        //send email
    	emailService.sendExamAssignmentEmail(
    		    candidate.getEmail(),
    		    candidate.getFirstname(),
    		    examCenter.getName(),         // Nom du centre d'examen
    		    session.getExamDate().toString()         // Formatée proprement si besoin
    		);


    }
    
    
}
